- zipcode = params[:zipcode] || @order.shipping_postalcode
- postcode, locations = @shipping_gateway.smartpost_lookup(zipcode)

#gateway{data: {postcode: postcode.to_json, locations: locations.to_json}}

.smartpost-success{style: 'display: none;'}
  .thumbnail{style: 'position: relative; height: 0; padding-bottom: 61.8%; background-color: #eee;'}
    #map{style: 'position: absolute; left: 0; right: 0; top: 0; bottom: 0;'}

.smartpost-error.alert.alert-danger{style: 'display: none;'}
  = icon('warning', t('.lookup_error'))

= form_tag shipping_method_path(@order, @shipping_method), method: :get, remote: true do
  .form-group.zipcode-lookup
    .input-group
      = text_field_tag :zipcode, zipcode, class: 'form-control text-right'
      .input-group-btn
        = button_tag class: 'btn btn-default' do
          = icon('search', t('.zipcode'))

- if locations.present?
  = form_tag ship_path(@order, @shipping_method), remote: true, id: 'smartpost-form' do
    = hidden_field_tag :metadata
    .form-group
      .btn-group-vertical.center-block{data: {toggle: 'buttons'}}
        - locations.each do |loc|
          %label.btn.btn-default{style: 'text-align: left;'}
            = radio_button_tag 'pup_code', loc['PupCode']
            %strong= loc['PublicName']
            = loc['Address']
            = loc['Municipality']
            .small= loc['AdditionalInfo']
    .ship-button.collapse.hidden-print
      = button_tag t('checkout.ship'), class: 'btn btn-block btn-lg btn-primary'

  :coffee
    $('.smartpost-success').show()

    $gateway = $('#gateway')
    postcode = $gateway.data 'postcode'
    locations = $gateway.data 'locations'
    metadata = {}

    $map = $('#map')[0]
    markers = {}
    map = new google.maps.Map $map,
      center: {lat: postcode.MapLatitude, lng: postcode.MapLongitude}
      zoom: 12
      mapTypeControl: false
      streetViewControl: false
    for loc in locations
      metadata[loc.PupCode] = loc
      marker = new google.maps.Marker
        map: map
        position: {lat: loc.MapLatitude, lng: loc.MapLongitude}
        title: loc.PublicName + "\n" + loc.Address
        target: '#pup_code_' + loc.PupCode
      marker.activate = ->
        v.setAnimation null for k, v of markers
        map.panTo this.getPosition()
        this.setAnimation google.maps.Animation.BOUNCE
      marker.addListener 'click', ->
        this.activate()
        $(this.target).trigger 'click'
      markers['pup_code_' + loc.PupCode] = marker

    $('#smartpost-form').on 'change', (e) ->
      meta = metadata[$(e.target).val()]
      $('#metadata').val JSON.stringify(meta)
      markers[e.target.id].activate()
      $('.ship-button').collapse 'show'

- else
  :coffee
    $('.smartpost-error').show()
    $('.zipcode-lookup').addClass 'has-error'
    $('#zipcode').focus().select()
