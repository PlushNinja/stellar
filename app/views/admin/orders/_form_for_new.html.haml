= bootstrap_form_for [:admin, order], layout: :horizontal,
    label_col: 'col-sm-4', control_col: 'col-sm-8' do |f|
  .panel.panel-default
    .panel-body
      %fieldset
        = f.select :customer_id, @customers.map { |c| [c.to_s, c.id] }, {include_blank: t('.new_customer')}
        = f.select :group_id, @groups.map { |g| [g.name, g.id, data: {url: admin_group_path(g), appearance: g.appearance}.to_json] }
        = f.select :order_type_id, @group.outgoing_order_types.map { |o| [o.to_s, o.id] }, {}, {required: true}
      %hr
      %fieldset
        = render partial: 'customer_fields', locals: {f: f}
      %fieldset.actions
        = f.form_group do
          = f.primary

:coffee
  $customer_select = $('#order_customer_id').selectize
    allowEmptyOption: true
    onChange: (id) ->
      $.ajax
        url: '#{new_admin_order_path}'
        type: 'GET'
        dataType: 'script'
        data:
          order:
            customer_id: id

  $group_select = $('#order_group_id').selectize
    labelField: 'title'
    dataAttr: 'data'
    render: $.fn.selectize.label_renderer
    onChange: (id) ->
      order_type_select.clearOptions()
      order_type_select.load (callback) ->
        $.ajax
          url: group_select.options[id].url
          type: 'GET'
          dataType: 'json'
          error: ->
            callback()
          success: (response) ->
            types = response.outgoing_order_types
            if types.length > 0
              callback(types)
              order_type_select.setValue types[0].id

  $order_type_select = $('#order_order_type_id').selectize
    valueField: 'id'
    labelField: 'name'

  customer_select = $customer_select[0].selectize
  group_select = $group_select[0].selectize
  order_type_select = $order_type_select[0].selectize
