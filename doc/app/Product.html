<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8">

<title>class Product - Rails Application Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link">ActiveRecord::Base
  
</div>

    <div id="includes-section" class="nav-section">
  <h3>Included Modules</h3>

  <ul class="link-list">
  
  
    <li><span class="include">Authority::Abilities</span>
  
  
  
    <li><a class="include" href="Imageable.html">Imageable</a>
  
  
  
    <li><a class="include" href="Reorderable.html">Reorderable</a>
  
  
  
    <li><span class="include">FriendlyId</span>
  
  
  </ul>
</div>

    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-availability_options">::availability_options</a>
    
    <li ><a href="#method-c-purpose_options">::purpose_options</a>
    
    <li ><a href="#method-c-update_from_csv_row">::update_from_csv_row</a>
    
    <li ><a href="#method-i-active_promoted_items">#active_promoted_items</a>
    
    <li class="calls-super" ><a href="#method-i-as_json">#as_json</a>
    
    <li ><a href="#method-i-available">#available</a>
    
    <li ><a href="#method-i-available-3F">#available?</a>
    
    <li ><a href="#method-i-available_by_inventory">#available_by_inventory</a>
    
    <li ><a href="#method-i-available_shipping_methods">#available_shipping_methods</a>
    
    <li ><a href="#method-i-available_variant_options">#available_variant_options</a>
    
    <li ><a href="#method-i-base_unit">#base_unit</a>
    
    <li ><a href="#method-i-best_promoted_item">#best_promoted_item</a>
    
    <li ><a href="#method-i-category">#category</a>
    
    <li ><a href="#method-i-codes">#codes</a>
    
    <li ><a href="#method-i-component_total_price_cents">#component_total_price_cents</a>
    
    <li ><a href="#method-i-consume-21">#consume!</a>
    
    <li ><a href="#method-i-distinct_properties">#distinct_properties</a>
    
    <li ><a href="#method-i-duplicate-21">#duplicate!</a>
    
    <li ><a href="#method-i-first_variant">#first_variant</a>
    
    <li ><a href="#method-i-formatted_price_string">#formatted_price_string</a>
    
    <li ><a href="#method-i-generate_variant_code">#generate_variant_code</a>
    
    <li ><a href="#method-i-has_master_properties-3F">#has_master_properties?</a>
    
    <li ><a href="#method-i-has_variants-3F">#has_variants?</a>
    
    <li ><a href="#method-i-icon">#icon</a>
    
    <li ><a href="#method-i-icon_image_url">#icon_image_url</a>
    
    <li ><a href="#method-i-includes_components-3F">#includes_components?</a>
    
    <li ><a href="#method-i-lead_time_days">#lead_time_days</a>
    
    <li ><a href="#method-i-limelightable-3F">#limelightable?</a>
    
    <li ><a href="#method-i-margin_percent">#margin_percent</a>
    
    <li ><a href="#method-i-markup_percent">#markup_percent</a>
    
    <li ><a href="#method-i-master-3F">#master?</a>
    
    <li ><a href="#method-i-price_cents">#price_cents</a>
    
    <li ><a href="#method-i-price_range">#price_range</a>
    
    <li ><a href="#method-i-price_tag_cents">#price_tag_cents</a>
    
    <li ><a href="#method-i-primary-3F">#primary?</a>
    
    <li ><a href="#method-i-product_properties_hash">#product_properties_hash</a>
    
    <li ><a href="#method-i-purchasable-3F">#purchasable?</a>
    
    <li ><a href="#method-i-real-3F">#real?</a>
    
    <li ><a href="#method-i-reset_code">#reset_code</a>
    
    <li ><a href="#method-i-reset_itself-21">#reset_itself!</a>
    
    <li ><a href="#method-i-reset_live_status-21">#reset_live_status!</a>
    
    <li ><a href="#method-i-reset_promoted_price-21">#reset_promoted_price!</a>
    
    <li ><a href="#method-i-restock-21">#restock!</a>
    
    <li ><a href="#method-i-searchable_product_properties">#searchable_product_properties</a>
    
    <li class="calls-super" ><a href="#method-i-should_generate_new_friendly_id-3F">#should_generate_new_friendly_id?</a>
    
    <li ><a href="#method-i-sibling_variants">#sibling_variants</a>
    
    <li ><a href="#method-i-slugger">#slugger</a>
    
    <li ><a href="#method-i-to_s">#to_s</a>
    
    <li ><a href="#method-i-touch_categories">#touch_categories</a>
    
    <li ><a href="#method-i-tracked_stock-3F">#tracked_stock?</a>
    
    <li ><a href="#method-i-unique_properties">#unique_properties</a>
    
    <li ><a href="#method-i-unit_price_cents">#unit_price_cents</a>
    
    <li ><a href="#method-i-variant-3F">#variant?</a>
    
    <li ><a href="#method-i-variants_with_master_properties">#variants_with_master_properties</a>
    
    <li ><a href="#method-i-vary_from">#vary_from</a>
    
    <li ><a href="#method-i-visible-3F">#visible?</a>
    
    <li ><a href="#method-i-with_requisite_products">#with_requisite_products</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Product">
  <h1 id="class-Product" class="class">
    class Product
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="INLINE_SEARCH_RESULTS">INLINE_SEARCH_RESULTS
        
        <dd>
        
      
        <dt id="PURPOSE_ICONS">PURPOSE_ICONS
        
        <dd>
        
      
      </dl>
    </section>
    

    
    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      
      <div id="attribute-i-requisite_ids_string" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">requisite_ids_string</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
    </section>
    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-availability_options" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">availability_options</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Options for a search form.</p>
          
          

          
          <div class="method-source-code" id="availability_options-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 148</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">availability_options</span>
  [
    [<span class="ruby-identifier">human_attribute_name</span>(<span class="ruby-value">:live</span>), <span class="ruby-keyword">true</span>],
    [<span class="ruby-identifier">human_attribute_name</span>(<span class="ruby-value">:not_live</span>), <span class="ruby-keyword">false</span>]
  ]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-purpose_options" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">purpose_options</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="purpose_options-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 143</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">purpose_options</span>
  <span class="ruby-identifier">purposes</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> [<span class="ruby-constant">Product</span>.<span class="ruby-identifier">human_attribute_value</span>(<span class="ruby-value">:purpose</span>, <span class="ruby-identifier">p</span>), <span class="ruby-identifier">p</span>] }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-update_from_csv_row" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_from_csv_row</span><span
            class="method-args">(store, inventory, row, code)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Takes a CSV::Row and updates a product from its data in the given store and
inventory. Returns the updated product, or nil if it fails. Supported
fields: product_code     : required retail_price     : anything supported
by Monetize.parse inventory_amount : targets the first inventory</p>
          
          

          
          <div class="method-source-code" id="update_from_csv_row-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 161</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">update_from_csv_row</span>(<span class="ruby-identifier">store</span>, <span class="ruby-identifier">inventory</span>, <span class="ruby-identifier">row</span>, <span class="ruby-identifier">code</span>)
  <span class="ruby-identifier">product</span> = <span class="ruby-identifier">store</span>.<span class="ruby-identifier">products</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">code</span><span class="ruby-operator">:</span> <span class="ruby-identifier">row</span>[<span class="ruby-value">:product_code</span>]).<span class="ruby-identifier">first</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">product</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">inventory</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-keyword">begin</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">row</span>[<span class="ruby-value">:retail_price</span>].<span class="ruby-identifier">present?</span>
      <span class="ruby-identifier">product</span>.<span class="ruby-identifier">update!</span>(<span class="ruby-identifier">retail_price</span><span class="ruby-operator">:</span> <span class="ruby-identifier">row</span>[<span class="ruby-value">:retail_price</span>].<span class="ruby-identifier">to_money</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">row</span>[<span class="ruby-value">:inventory_amount</span>].<span class="ruby-identifier">present?</span>
      <span class="ruby-identifier">product</span>.<span class="ruby-identifier">inventory_items</span>.<span class="ruby-identifier">destroy_all</span>
      <span class="ruby-identifier">amount</span> = <span class="ruby-identifier">row</span>[<span class="ruby-value">:inventory_amount</span>].<span class="ruby-identifier">to_i</span>
      <span class="ruby-identifier">amount</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">amount</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
      <span class="ruby-identifier">product</span>.<span class="ruby-identifier">restock!</span>(<span class="ruby-identifier">inventory</span>, <span class="ruby-identifier">code</span>, <span class="ruby-identifier">amount</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">product</span>
  <span class="ruby-keyword">rescue</span>
    <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-active_promoted_items" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">active_promoted_items</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="active_promoted_items-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 265</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">active_promoted_items</span>
  <span class="ruby-identifier">promoted_items</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:promotion</span>).<span class="ruby-identifier">merge</span>(<span class="ruby-constant">Promotion</span>.<span class="ruby-identifier">active</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-as_json" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">as_json</span><span
            class="method-args">(options = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="as_json-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 496</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">as_json</span>(<span class="ruby-identifier">options</span> = {})
  <span class="ruby-keyword">super</span>({
    <span class="ruby-identifier">only</span><span class="ruby-operator">:</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:code</span>, <span class="ruby-value">:customer_code</span>, <span class="ruby-value">:title</span>, <span class="ruby-value">:subtitle</span>],
    <span class="ruby-identifier">methods</span><span class="ruby-operator">:</span> [<span class="ruby-value">:icon_image_url</span>]
  }.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">options</span>))
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-available" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">available</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Amount available in all inventories.</p>
          
          

          
          <div class="method-source-code" id="available-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 348</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">available</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">tracked_stock?</span>
    <span class="ruby-identifier">inventory_items</span>.<span class="ruby-identifier">online</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:available</span>).<span class="ruby-identifier">sum</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Float</span><span class="ruby-operator">::</span><span class="ruby-constant">INFINITY</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-available-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">available?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p><a href="Product.html">Product</a> is considered available when it&#39;s
live and has either inventory available, or a defined lead time.</p>
          
          

          
          <div class="method-source-code" id="available-3F-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 358</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">available?</span>
  <span class="ruby-identifier">live?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">lead_time</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">available</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-available_by_inventory" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">available_by_inventory</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Coalesced amount available by inventory.</p>
          
          

          
          <div class="method-source-code" id="available_by_inventory-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 375</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">available_by_inventory</span>
  <span class="ruby-identifier">amounts</span> = <span class="ruby-identifier">inventory_items</span>.<span class="ruby-identifier">online</span>.<span class="ruby-identifier">group</span>(<span class="ruby-value">:inventory_id</span>).<span class="ruby-identifier">sum</span>(<span class="ruby-string">&#39;on_hand - reserved&#39;</span>)
  <span class="ruby-identifier">amounts</span>.<span class="ruby-identifier">transform_keys</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span> <span class="ruby-constant">Inventory</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>) }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-available_shipping_methods" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">available_shipping_methods</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Finds the available shipping methods from associated active shipping
methods if any, defaulting to all active shipping methods.</p>
          
          

          
          <div class="method-source-code" id="available_shipping_methods-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 370</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">available_shipping_methods</span>
  <span class="ruby-identifier">shipping_methods</span>.<span class="ruby-identifier">active</span>.<span class="ruby-identifier">presence</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">store</span>.<span class="ruby-identifier">shipping_methods</span>.<span class="ruby-identifier">active</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-available_variant_options" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">available_variant_options</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="available_variant_options-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 418</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">available_variant_options</span>
  <span class="ruby-identifier">store</span>.<span class="ruby-identifier">products</span>.<span class="ruby-identifier">variant</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">p</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>] }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-base_unit" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">base_unit</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns the unit (if any) that unit pricing is based on.</p>
          
          

          
          <div class="method-source-code" id="base_unit-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 313</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">base_unit</span>
  <span class="ruby-identifier">product_property</span> = <span class="ruby-identifier">unit_pricing_property</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">product_property</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-identifier">product_property</span>.<span class="ruby-identifier">property</span>.<span class="ruby-identifier">measurement_unit</span>.<span class="ruby-identifier">pricing_base</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-best_promoted_item" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">best_promoted_item</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Finds the promoted item with the lowest quoted price.</p>
          
          

          
          <div class="method-source-code" id="best_promoted_item-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 270</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">best_promoted_item</span>
  <span class="ruby-identifier">lowest</span> = <span class="ruby-identifier">active_promoted_items</span>.<span class="ruby-identifier">pluck</span>(<span class="ruby-value">:price_cents</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lowest</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-identifier">active_promoted_items</span>.<span class="ruby-identifier">find_by</span>(<span class="ruby-identifier">price_cents</span><span class="ruby-operator">:</span> <span class="ruby-identifier">lowest</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-category" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">category</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>If a single category is requested, give the deepest live one.</p>
          
          

          
          <div class="method-source-code" id="category-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 251</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">category</span>
  <span class="ruby-identifier">categories</span>.<span class="ruby-identifier">live</span>.<span class="ruby-identifier">order</span>(<span class="ruby-identifier">depth</span><span class="ruby-operator">:</span> <span class="ruby-value">:desc</span>, <span class="ruby-identifier">lft</span><span class="ruby-operator">:</span> <span class="ruby-value">:asc</span>).<span class="ruby-identifier">first</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-codes" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">codes</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="codes-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 488</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">codes</span>
  <span class="ruby-identifier">customer_code</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">?</span> <span class="ruby-node">&quot;#{customer_code} ⧸ #{code}&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">code</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-component_total_price_cents" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">component_total_price_cents</span><span
            class="method-args">(pricing_group)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Total price of components.</p>
          
          

          
          <div class="method-source-code" id="component_total_price_cents-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 297</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">component_total_price_cents</span>(<span class="ruby-identifier">pricing_group</span>)
  <span class="ruby-identifier">component_entries</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">entry</span><span class="ruby-operator">|</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">quantity</span> <span class="ruby-operator">*</span> (<span class="ruby-identifier">entry</span>.<span class="ruby-identifier">component</span>.<span class="ruby-identifier">price_cents</span>(<span class="ruby-identifier">pricing_group</span>) <span class="ruby-operator">||</span> <span class="ruby-value">0</span>) }.<span class="ruby-identifier">sum</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-consume-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">consume!</span><span
            class="method-args">(amount, source = nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Consumes given amount of this product from inventory, starting from the
oldest stock. Multiple inventory items may be affected to satisfy the
consumed amount. Returns false if we have insufficient stock available.</p>
          
          

          
          <div class="method-source-code" id="consume-21-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 402</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">consume!</span>(<span class="ruby-identifier">amount</span>, <span class="ruby-identifier">source</span> = <span class="ruby-keyword">nil</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">tracked_stock?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">amount</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">available</span>
  <span class="ruby-identifier">inventory_items</span>.<span class="ruby-identifier">online</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">available</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">amount</span>
      <span class="ruby-comment"># This inventory item satisfies the amount, destock and finish.</span>
      <span class="ruby-identifier">item</span>.<span class="ruby-identifier">destock!</span>(<span class="ruby-identifier">amount</span>, <span class="ruby-identifier">source</span>)
      <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># Continue with remaining amount after destocking all of this item.</span>
      <span class="ruby-identifier">amount</span> <span class="ruby-operator">-=</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">available</span>
      <span class="ruby-identifier">item</span>.<span class="ruby-identifier">destock!</span>(<span class="ruby-identifier">item</span>.<span class="ruby-identifier">available</span>, <span class="ruby-identifier">source</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-distinct_properties" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">distinct_properties</span><span
            class="method-args">(product)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Finds product properties that differ from the baseline established by given
product. Properties unique to this product are retained.</p>
          
          

          
          <div class="method-source-code" id="distinct_properties-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 236</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">distinct_properties</span>(<span class="ruby-identifier">product</span>)
  <span class="ruby-identifier">baseline</span> = <span class="ruby-identifier">product</span>.<span class="ruby-identifier">product_properties_hash</span>
  <span class="ruby-identifier">product_properties</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">product_property</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">baseline</span>[<span class="ruby-identifier">product_property</span>.<span class="ruby-identifier">property_id</span>] <span class="ruby-operator">!=</span> <span class="ruby-identifier">product_property</span>.<span class="ruby-identifier">value</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-duplicate-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">duplicate!</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a duplicate of this product, including associations. Any variants
the product may have are not duplicated.</p>
          
          

          
          <div class="method-source-code" id="duplicate-21-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 440</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">duplicate!</span>
  <span class="ruby-identifier">clone</span> = <span class="ruby-identifier">dup</span>.<span class="ruby-identifier">tap</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">c</span>.<span class="ruby-identifier">reset_code</span>
    <span class="ruby-identifier">c</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-identifier">c</span>.<span class="ruby-identifier">update</span>(
      <span class="ruby-identifier">categories</span><span class="ruby-operator">:</span> <span class="ruby-identifier">categories</span>,
      <span class="ruby-identifier">component_products</span><span class="ruby-operator">:</span> <span class="ruby-identifier">component_products</span>,
      <span class="ruby-identifier">requisite_products</span><span class="ruby-operator">:</span> <span class="ruby-identifier">requisite_products</span>,
      <span class="ruby-identifier">iframes</span><span class="ruby-operator">:</span> <span class="ruby-identifier">iframes</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:dup</span>),
      <span class="ruby-identifier">alternate_prices</span><span class="ruby-operator">:</span> <span class="ruby-identifier">alternate_prices</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:dup</span>),
      <span class="ruby-identifier">product_properties</span><span class="ruby-operator">:</span> <span class="ruby-identifier">product_properties</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:dup</span>)
    )
    <span class="ruby-identifier">images</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">image</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">images</span>.<span class="ruby-identifier">create</span>(
        <span class="ruby-identifier">priority</span><span class="ruby-operator">:</span> <span class="ruby-identifier">image</span>.<span class="ruby-identifier">priority</span>,
        <span class="ruby-identifier">purpose</span><span class="ruby-operator">:</span> <span class="ruby-identifier">image</span>.<span class="ruby-identifier">purpose</span>,
        <span class="ruby-identifier">attachment</span><span class="ruby-operator">:</span> <span class="ruby-identifier">image</span>.<span class="ruby-identifier">attachment</span>
      )
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-first_variant" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">first_variant</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Finds the primary or first live variant for this product. Returns self if
not a master product or there are no variants.</p>
          
          

          
          <div class="method-source-code" id="first_variant-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 214</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">first_variant</span>
  <span class="ruby-identifier">master?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">primary_variant</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">variants</span>.<span class="ruby-identifier">live</span>.<span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-formatted_price_string" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">formatted_price_string</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Retail price string representation for JSON.</p>
          
          

          
          <div class="method-source-code" id="formatted_price_string-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 508</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">formatted_price_string</span>
  <span class="ruby-identifier">retail_price</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">retail_price</span>.<span class="ruby-identifier">format</span> <span class="ruby-operator">:</span> <span class="ruby-string">&#39;&#39;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-generate_variant_code" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">generate_variant_code</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="generate_variant_code-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 462</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">generate_variant_code</span>
  <span class="ruby-node">&quot;#{code}-#{variants.count}&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-has_master_properties-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">has_master_properties?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="has_master_properties-3F-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 222</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">has_master_properties?</span>
  <span class="ruby-identifier">variant?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">master_product</span>.<span class="ruby-identifier">properties</span>.<span class="ruby-identifier">any?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-has_variants-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">has_variants?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="has_variants-3F-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 196</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">has_variants?</span>
  <span class="ruby-identifier">variants</span>.<span class="ruby-identifier">any?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-icon" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">icon</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Icon name based on purpose.</p>
          
          

          
          <div class="method-source-code" id="icon-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 484</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">icon</span>
  <span class="ruby-constant">PURPOSE_ICONS</span>[<span class="ruby-identifier">purpose</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-icon_image_url" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">icon_image_url</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="icon_image_url-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 503</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">icon_image_url</span>
  <span class="ruby-identifier">cover_image</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">cover_image</span>(<span class="ruby-value">:presentational</span>).<span class="ruby-identifier">url</span>(<span class="ruby-value">:icon</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-includes_components-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">includes_components?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Bundles and composites include components when ordered, if any are live.</p>
          
          

          
          <div class="method-source-code" id="includes_components-3F-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 338</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">includes_components?</span>
  (<span class="ruby-identifier">bundle?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">composite?</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">component_entries</span>.<span class="ruby-identifier">live</span>.<span class="ruby-identifier">any?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-lead_time_days" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">lead_time_days</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Lead times that look like integers are parsed as number of days, other
non-blank strings are considered to be zero days.</p>
          
          

          
          <div class="method-source-code" id="lead_time_days-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 364</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">lead_time_days</span>
  <span class="ruby-identifier">lead_time</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lead_time</span>.<span class="ruby-identifier">to_i</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-limelightable-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">limelightable?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Limelighting a product in portal views needs both images and text.</p>
          
          

          
          <div class="method-source-code" id="limelightable-3F-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 479</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">limelightable?</span>
  <span class="ruby-identifier">cover_image</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">description</span>.<span class="ruby-identifier">present?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-margin_percent" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">margin_percent</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Margin percentage from trade price to retail price.</p>
          
          

          
          <div class="method-source-code" id="margin_percent-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 332</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">margin_percent</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">trade_price</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">retail_price</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">retail_price</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
  <span class="ruby-value">100</span> <span class="ruby-operator">*</span> (<span class="ruby-identifier">retail_price</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">trade_price</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">retail_price</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-markup_percent" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">markup_percent</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Markup percentage from trade price to retail price.</p>
          
          

          
          <div class="method-source-code" id="markup_percent-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 326</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">markup_percent</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">trade_price</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">retail_price</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">trade_price</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
  <span class="ruby-value">100</span> <span class="ruby-operator">*</span> (<span class="ruby-identifier">retail_price</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">trade_price</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">trade_price</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-master-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">master?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Master products are merely those that are not variants, regardless if they
have any assigned variants.</p>
          
          

          
          <div class="method-source-code" id="master-3F-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 188</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">master?</span>
  <span class="ruby-operator">!</span><span class="ruby-identifier">variant?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-price_cents" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">price_cents</span><span
            class="method-args">(pricing_group)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns the retail price in given pricing group. If no group is specified,
uses the promoted price, if any. Bundles sum their components if no price
is specified.</p>
          
          

          
          <div class="method-source-code" id="price_cents-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 279</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">price_cents</span>(<span class="ruby-identifier">pricing_group</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">bundle?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">retail_price_cents</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">component_total_price_cents</span>(<span class="ruby-identifier">pricing_group</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">pricing_group</span>.<span class="ruby-identifier">present?</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">alternate_prices</span>.<span class="ruby-identifier">find_by</span>(<span class="ruby-identifier">pricing_group</span><span class="ruby-operator">:</span> <span class="ruby-identifier">pricing_group</span>).<span class="ruby-identifier">try</span>(<span class="ruby-value">:retail_price_cents</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">retail_price_cents</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">promoted_price_cents</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">retail_price_cents</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-price_range" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">price_range</span><span
            class="method-args">(pricing_group)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns the range of price tags across variants of a master product.</p>
          
          

          
          <div class="method-source-code" id="price_range-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 320</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">price_range</span>(<span class="ruby-identifier">pricing_group</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">has_variants?</span>
  <span class="ruby-identifier">variants</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">variant</span><span class="ruby-operator">|</span> <span class="ruby-identifier">variant</span>.<span class="ruby-identifier">price_tag</span>(<span class="ruby-identifier">pricing_group</span>) }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">minmax</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-price_tag_cents" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">price_tag_cents</span><span
            class="method-args">(pricing_group)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns the display price in given pricing group. The price tag displays
retail price, with components added on for composite products.</p>
          
          

          
          <div class="method-source-code" id="price_tag_cents-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 291</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">price_tag_cents</span>(<span class="ruby-identifier">pricing_group</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">price_cents</span>(<span class="ruby-identifier">pricing_group</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">composite?</span>
  <span class="ruby-identifier">price_cents</span>(<span class="ruby-identifier">pricing_group</span>) <span class="ruby-operator">+</span> <span class="ruby-identifier">component_total_price_cents</span>(<span class="ruby-identifier">pricing_group</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-primary-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">primary?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="primary-3F-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 200</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">primary?</span>
  <span class="ruby-identifier">variant?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">master_product</span>.<span class="ruby-identifier">primary_variant</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-product_properties_hash" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">product_properties_hash</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Assigned product properties as a hash keyed by property id. Useful for
comparison, see <a
href="Product.html#method-i-distinct_properties">distinct_properties</a>.</p>
          
          

          
          <div class="method-source-code" id="product_properties_hash-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 261</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">product_properties_hash</span>
  <span class="ruby-identifier">product_properties</span>.<span class="ruby-identifier">pluck</span>(<span class="ruby-value">:property_id</span>, <span class="ruby-value">:value</span>).<span class="ruby-identifier">to_h</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-purchasable-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">purchasable?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="purchasable-3F-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 208</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">purchasable?</span>
  <span class="ruby-identifier">live?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">has_variants?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">vanilla?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">bundle?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">composite?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">virtual?</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">available?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-real-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">real?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="real-3F-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 182</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">real?</span>
  <span class="ruby-operator">!</span><span class="ruby-identifier">internal?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-reset_live_status-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reset_live_status!</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Resets the live status of the product, according to these criteria:</p>
<ul><li>
<p>retail price is not nil (or there are variants)</p>
</li><li>
<p>set to be available at a certain date which is not in the future</p>
</li><li>
<p>if set to be deleted at a certain date which is in the future</p>
</li></ul>
          
          

          
          <div class="method-source-code" id="reset_live_status-21-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 516</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">reset_live_status!</span>
  <span class="ruby-identifier">update_columns</span>(<span class="ruby-identifier">live</span><span class="ruby-operator">:</span> (<span class="ruby-identifier">retail_price_cents</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">has_variants?</span>) <span class="ruby-operator">&amp;&amp;</span>
    (<span class="ruby-identifier">available_at</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">available_at</span>.<span class="ruby-identifier">future?</span>) <span class="ruby-operator">&amp;&amp;</span>
    (<span class="ruby-identifier">deleted_at</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">deleted_at</span>.<span class="ruby-identifier">future?</span>))
  <span class="ruby-identifier">touch</span>
  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-reset_promoted_price-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reset_promoted_price!</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Resets the promoted price of the product by looking for the lowest price
from currently active promotions. Resets to nil if no promotions are found.</p>
          
          

          
          <div class="method-source-code" id="reset_promoted_price-21-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 526</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">reset_promoted_price!</span>
  <span class="ruby-identifier">lowest</span> = <span class="ruby-identifier">best_promoted_item</span>
  <span class="ruby-identifier">update_columns</span>(<span class="ruby-identifier">promoted_price_cents</span><span class="ruby-operator">:</span> <span class="ruby-identifier">lowest</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">lowest</span>.<span class="ruby-identifier">price_cents</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">touch</span>
  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-restock-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">restock!</span><span
            class="method-args">(inventory, code, amount, value = nil, recorded_at = nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Restocks given inventory with amount of this product with given lot code,
at given value. If value is not specified, uses the current value of the
targeted inventory item, defaulting to product cost price.</p>
          
          

          
          <div class="method-source-code" id="restock-21-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 383</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">restock!</span>(<span class="ruby-identifier">inventory</span>, <span class="ruby-identifier">code</span>, <span class="ruby-identifier">amount</span>, <span class="ruby-identifier">value</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">recorded_at</span> = <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">recorded_at</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>
  <span class="ruby-identifier">item</span> = <span class="ruby-identifier">inventory_items</span>.<span class="ruby-identifier">find_or_initialize_by</span>(
    <span class="ruby-identifier">inventory</span><span class="ruby-operator">:</span> <span class="ruby-identifier">inventory</span>,
    <span class="ruby-identifier">code</span><span class="ruby-operator">:</span> <span class="ruby-identifier">code</span>
  )
  <span class="ruby-identifier">item</span>.<span class="ruby-identifier">inventory_entries</span>.<span class="ruby-identifier">build</span>(
    <span class="ruby-identifier">recorded_at</span><span class="ruby-operator">:</span> <span class="ruby-identifier">recorded_at</span>,
    <span class="ruby-identifier">on_hand</span><span class="ruby-operator">:</span> <span class="ruby-identifier">amount</span>,
    <span class="ruby-identifier">reserved</span><span class="ruby-operator">:</span> <span class="ruby-value">0</span>,
    <span class="ruby-identifier">pending</span><span class="ruby-operator">:</span> <span class="ruby-value">0</span>,
    <span class="ruby-identifier">value</span><span class="ruby-operator">:</span> <span class="ruby-identifier">value</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">value</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">cost_price</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
  )
  <span class="ruby-identifier">item</span>.<span class="ruby-identifier">save!</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-searchable_product_properties" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">searchable_product_properties</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="searchable_product_properties-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 255</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">searchable_product_properties</span>
  <span class="ruby-identifier">product_properties</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:property</span>).<span class="ruby-identifier">merge</span>(<span class="ruby-constant">Property</span>.<span class="ruby-identifier">searchable</span>).<span class="ruby-identifier">merge</span>(<span class="ruby-constant">Property</span>.<span class="ruby-identifier">sorted</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-should_generate_new_friendly_id-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">should_generate_new_friendly_id?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="should_generate_new_friendly_id-3F-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 470</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">should_generate_new_friendly_id?</span>
  (<span class="ruby-identifier">title_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">subtitle_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">code_changed?</span>) <span class="ruby-operator">||</span> <span class="ruby-keyword">super</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sibling_variants" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sibling_variants</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="sibling_variants-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 218</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">sibling_variants</span>
  <span class="ruby-identifier">master_product</span>.<span class="ruby-identifier">variants</span>.<span class="ruby-identifier">where</span>.<span class="ruby-identifier">not</span>(<span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-keyword">self</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-slugger" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">slugger</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="slugger-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 466</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">slugger</span>
  [[<span class="ruby-value">:title</span>, <span class="ruby-value">:subtitle</span>, <span class="ruby-value">:code</span>], [<span class="ruby-value">:title</span>, <span class="ruby-value">:subtitle</span>, <span class="ruby-value">:code</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">store</span>.<span class="ruby-identifier">name</span> }]]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-to_s" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">to_s</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="to_s-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 492</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">to_s</span>
  <span class="ruby-node">&quot;#{title} #{subtitle}&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-tracked_stock-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">tracked_stock?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Stock is not tracked for bundles, virtual or internal products.</p>
          
          

          
          <div class="method-source-code" id="tracked_stock-3F-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 343</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">tracked_stock?</span>
  <span class="ruby-identifier">vanilla?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">composite?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-unique_properties" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">unique_properties</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Finds the set of unique properties across all variants of a master product.
Returns a hash keyed by property, or an empty set if there are no variants.</p>
          
          

          
          <div class="method-source-code" id="unique_properties-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 245</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">unique_properties</span>
  <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">has_variants?</span>
  <span class="ruby-identifier">variants</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:product_properties</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:property</span>).<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">p</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">uniq</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:value</span>).<span class="ruby-identifier">count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-unit_price_cents" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">unit_price_cents</span><span
            class="method-args">(total_cents)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Calculates unit price from given total cents by finding a product property
that declares unit pricing.</p>
          
          

          
          <div class="method-source-code" id="unit_price_cents-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 303</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">unit_price_cents</span>(<span class="ruby-identifier">total_cents</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">total_cents</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-identifier">product_property</span> = <span class="ruby-identifier">unit_pricing_property</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">product_property</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">product_property</span>.<span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-identifier">measure</span> = <span class="ruby-identifier">product_property</span>.<span class="ruby-identifier">value</span>.<span class="ruby-identifier">tr</span>(<span class="ruby-string">&#39;,&#39;</span>, <span class="ruby-string">&#39;.&#39;</span>).<span class="ruby-identifier">to_f</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">measure</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">total_cents</span> <span class="ruby-operator">/</span> (<span class="ruby-identifier">measure</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">product_property</span>.<span class="ruby-identifier">property</span>.<span class="ruby-identifier">measurement_unit</span>.<span class="ruby-identifier">factor</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-variant-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">variant?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="variant-3F-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 192</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">variant?</span>
  <span class="ruby-identifier">master_product</span>.<span class="ruby-identifier">present?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-variants_with_master_properties" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">variants_with_master_properties</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="variants_with_master_properties-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 226</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">variants_with_master_properties</span>
  <span class="ruby-keyword">return</span> {} <span class="ruby-keyword">unless</span> <span class="ruby-identifier">has_variants?</span>
  <span class="ruby-identifier">variants</span>.<span class="ruby-identifier">live</span>.<span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-identifier">product_properties</span><span class="ruby-operator">:</span> <span class="ruby-value">:property</span>)
    .<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
      [<span class="ruby-identifier">v</span>, <span class="ruby-identifier">v</span>.<span class="ruby-identifier">product_properties</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">properties</span><span class="ruby-operator">:</span> {<span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">properties</span>})]
    }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-vary_from" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">vary_from</span><span
            class="method-args">(master)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Copies certain attributes from given master to create a valid variant.</p>
          
          

          
          <div class="method-source-code" id="vary_from-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 423</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">vary_from</span>(<span class="ruby-identifier">master</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">assign_attributes</span>(
    <span class="ruby-identifier">purpose</span><span class="ruby-operator">:</span> <span class="ruby-identifier">master</span>.<span class="ruby-identifier">purpose</span>,
    <span class="ruby-identifier">master_product</span><span class="ruby-operator">:</span> <span class="ruby-identifier">master</span>,
    <span class="ruby-identifier">categories</span><span class="ruby-operator">:</span> <span class="ruby-identifier">master</span>.<span class="ruby-identifier">categories</span>,
    <span class="ruby-identifier">code</span><span class="ruby-operator">:</span> <span class="ruby-identifier">master</span>.<span class="ruby-identifier">generate_variant_code</span>,
    <span class="ruby-identifier">title</span><span class="ruby-operator">:</span> <span class="ruby-identifier">master</span>.<span class="ruby-identifier">title</span>,
    <span class="ruby-identifier">subtitle</span><span class="ruby-operator">:</span> <span class="ruby-identifier">master</span>.<span class="ruby-identifier">subtitle</span>,
    <span class="ruby-identifier">cost_price_cents</span><span class="ruby-operator">:</span> <span class="ruby-identifier">master</span>.<span class="ruby-identifier">cost_price_cents</span>,
    <span class="ruby-identifier">trade_price_cents</span><span class="ruby-operator">:</span> <span class="ruby-identifier">master</span>.<span class="ruby-identifier">trade_price_cents</span>,
    <span class="ruby-identifier">retail_price_cents</span><span class="ruby-operator">:</span> <span class="ruby-identifier">master</span>.<span class="ruby-identifier">retail_price_cents</span>,
    <span class="ruby-identifier">tax_category</span><span class="ruby-operator">:</span> <span class="ruby-identifier">master</span>.<span class="ruby-identifier">tax_category</span>,
  )
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-visible-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">visible?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="visible-3F-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 204</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">visible?</span>
  <span class="ruby-identifier">live?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">master?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">vanilla?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">bundle?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">composite?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">virtual?</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-with_requisite_products" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">with_requisite_products</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="with_requisite_products-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 474</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">with_requisite_products</span>
  [<span class="ruby-keyword">self</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">requisite_products</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="protected-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Protected Instance Methods</h3>
       </header>

    
      <div id="method-i-reset_code" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reset_code</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Adds an incrementing branch number to the product code.</p>
          
          

          
          <div class="method-source-code" id="reset_code-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 546</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">reset_code</span>
  <span class="ruby-keyword">while</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid?</span>
    <span class="ruby-identifier">trunk</span>, <span class="ruby-identifier">branch</span> = <span class="ruby-identifier">code</span>.<span class="ruby-identifier">partition</span>(<span class="ruby-regexp">/ \(\d+\)/</span>)
    <span class="ruby-identifier">branch</span> = <span class="ruby-string">&#39; (0)&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">branch</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-keyword">self</span>[<span class="ruby-value">:code</span>] = <span class="ruby-node">&quot;#{trunk}#{branch.succ}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-reset_itself-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reset_itself!</span><span
            class="method-args">(context)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="reset_itself-21-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 534</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">reset_itself!</span>(<span class="ruby-identifier">context</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">persisted?</span>
    <span class="ruby-identifier">reset_live_status!</span>
    <span class="ruby-identifier">reset_promoted_price!</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-touch_categories" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">touch_categories</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="touch_categories-source">
            <pre><span class="ruby-comment"># File app/models/product.rb, line 541</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">touch_categories</span>
  <span class="ruby-identifier">categories</span>.<span class="ruby-identifier">each</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:touch</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.3.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

