<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8">

<title>class Order - Rails Application Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link">ActiveRecord::Base
  
</div>

    <div id="includes-section" class="nav-section">
  <h3>Included Modules</h3>

  <ul class="link-list">
  
  
    <li><span class="include">Authority::Abilities</span>
  
  
  
    <li><a class="include" href="Trackable.html">Trackable</a>
  
  
  
    <li><a class="include" href="Adjustable.html">Adjustable</a>
  
  
  </ul>
</div>

    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-statuses">::statuses</a>
    
    <li ><a href="#method-i-address_to_customer">#address_to_customer</a>
    
    <li ><a href="#method-i-adjustments_sans_tax">#adjustments_sans_tax</a>
    
    <li ><a href="#method-i-adjustments_with_tax">#adjustments_with_tax</a>
    
    <li ><a href="#method-i-appearance">#appearance</a>
    
    <li ><a href="#method-i-apply_shipping_cost-21">#apply_shipping_cost!</a>
    
    <li ><a href="#method-i-approved-3F">#approved?</a>
    
    <li ><a href="#method-i-archive-21">#archive!</a>
    
    <li class="calls-super" ><a href="#method-i-as_json">#as_json</a>
    
    <li ><a href="#method-i-assign_number-21">#assign_number!</a>
    
    <li ><a href="#method-i-available_order_types">#available_order_types</a>
    
    <li ><a href="#method-i-available_shipping_methods">#available_shipping_methods</a>
    
    <li ><a href="#method-i-balance">#balance</a>
    
    <li ><a href="#method-i-billing_address_components">#billing_address_components</a>
    
    <li ><a href="#method-i-billing_address_required-3F">#billing_address_required?</a>
    
    <li ><a href="#method-i-cancelled-3F">#cancelled?</a>
    
    <li ><a href="#method-i-checkout_phase">#checkout_phase</a>
    
    <li ><a href="#method-i-checkoutable-3F">#checkoutable?</a>
    
    <li ><a href="#method-i-clear_shipping_costs-21">#clear_shipping_costs!</a>
    
    <li ><a href="#method-i-complete-21">#complete!</a>
    
    <li ><a href="#method-i-complete-3F">#complete?</a>
    
    <li ><a href="#method-i-concludable-3F">#concludable?</a>
    
    <li ><a href="#method-i-concluded-3F">#concluded?</a>
    
    <li ><a href="#method-i-contact_string">#contact_string</a>
    
    <li ><a href="#method-i-copy_items_to">#copy_items_to</a>
    
    <li ><a href="#method-i-current-3F">#current?</a>
    
    <li ><a href="#method-i-customer_pricing">#customer_pricing</a>
    
    <li ><a href="#method-i-customer_string">#customer_string</a>
    
    <li ><a href="#method-i-earliest_shipping_at">#earliest_shipping_at</a>
    
    <li ><a href="#method-i-editable_items-3F">#editable_items?</a>
    
    <li ><a href="#method-i-email">#email</a>
    
    <li ><a href="#method-i-empty-3F">#empty?</a>
    
    <li ><a href="#method-i-external_identifier">#external_identifier</a>
    
    <li ><a href="#method-i-forward_to">#forward_to</a>
    
    <li ><a href="#method-i-fully_shipped-3F">#fully_shipped?</a>
    
    <li ><a href="#method-i-grand_total_for_export">#grand_total_for_export</a>
    
    <li ><a href="#method-i-grand_total_sans_tax">#grand_total_sans_tax</a>
    
    <li ><a href="#method-i-grand_total_with_tax">#grand_total_with_tax</a>
    
    <li ><a href="#method-i-has_contact_info-3F">#has_contact_info?</a>
    
    <li ><a href="#method-i-has_installation-3F">#has_installation?</a>
    
    <li ><a href="#method-i-has_payment-3F">#has_payment?</a>
    
    <li ><a href="#method-i-has_pending_shipment-3F">#has_pending_shipment?</a>
    
    <li ><a href="#method-i-has_shipping-3F">#has_shipping?</a>
    
    <li ><a href="#method-i-icon">#icon</a>
    
    <li ><a href="#method-i-incomplete-3F">#incomplete?</a>
    
    <li ><a href="#method-i-insert">#insert</a>
    
    <li ><a href="#method-i-insert_components">#insert_components</a>
    
    <li ><a href="#method-i-insert_single">#insert_single</a>
    
    <li ><a href="#method-i-items_by_vendor">#items_by_vendor</a>
    
    <li ><a href="#method-i-items_pending_shipping">#items_pending_shipping</a>
    
    <li ><a href="#method-i-lead_time_days">#lead_time_days</a>
    
    <li ><a href="#method-i-life_pro_tip">#life_pro_tip</a>
    
    <li ><a href="#method-i-notified_users">#notified_users</a>
    
    <li ><a href="#method-i-order_type_name">#order_type_name</a>
    
    <li ><a href="#method-i-paid-3F">#paid?</a>
    
    <li ><a href="#method-i-pending-3F">#pending?</a>
    
    <li ><a href="#method-i-recalculate-21">#recalculate!</a>
    
    <li ><a href="#method-i-requires_shipping-3F">#requires_shipping?</a>
    
    <li ><a href="#method-i-should_complete-3F">#should_complete?</a>
    
    <li ><a href="#method-i-should_copy_billing_address-3F">#should_copy_billing_address?</a>
    
    <li ><a href="#method-i-size">#size</a>
    
    <li ><a href="#method-i-source">#source</a>
    
    <li ><a href="#method-i-summary">#summary</a>
    
    <li ><a href="#method-i-targeted-3F">#targeted?</a>
    
    <li ><a href="#method-i-tax_total">#tax_total</a>
    
    <li ><a href="#method-i-timeline_events">#timeline_events</a>
    
    <li ><a href="#method-i-to_s">#to_s</a>
    
    <li ><a href="#method-i-track_shipments-3F">#track_shipments?</a>
    
    <li ><a href="#method-i-vat_number_expected-3F">#vat_number_expected?</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Order">
  <h1 id="class-Order" class="class">
    class Order
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    
    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      
      <div id="attribute-i-group_id" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">group_id</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>This attribute allows specifying a group for an order created from scratch
with nested customer data.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-is_final" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">is_final</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>This attribute allows admins to finalize an order, both completing and
approving it at once.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-product_ids_string" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">product_ids_string</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
    </section>
    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-statuses" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">statuses</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="statuses-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 81</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">statuses</span>
  [<span class="ruby-value">:current</span>, <span class="ruby-value">:pending</span>, <span class="ruby-value">:concluded</span>, <span class="ruby-value">:cancelled</span>, <span class="ruby-value">:incomplete</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-address_to_customer" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">address_to_customer</span><span
            class="method-args">(guest = false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Addresses the order to its customer unless guest mode is specified. In any
case will ensure that country codes are set.</p>
          
          

          
          <div class="method-source-code" id="address_to_customer-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 83</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">address_to_customer</span>(<span class="ruby-identifier">guest</span> = <span class="ruby-keyword">false</span>)
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">guest</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">customer_email</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">email</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">customer_name</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">customer_phone</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">phone</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shipping_address</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">shipping_address</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shipping_postalcode</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">shipping_postalcode</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shipping_city</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">shipping_city</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shipping_country</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">shipping_country</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">billing_address</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">billing_address</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">billing_postalcode</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">billing_postalcode</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">billing_city</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">billing_city</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">billing_country</span> = <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">billing_country</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">ensure_valid_countries</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-adjustments_sans_tax" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adjustments_sans_tax</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="adjustments_sans_tax-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 235</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">adjustments_sans_tax</span>
  <span class="ruby-identifier">adjustments</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">amount_sans_tax</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>.<span class="ruby-identifier">to_money</span> }.<span class="ruby-identifier">sum</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-adjustments_with_tax" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adjustments_with_tax</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="adjustments_with_tax-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 239</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">adjustments_with_tax</span>
  <span class="ruby-identifier">adjustments</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">amount_with_tax</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>.<span class="ruby-identifier">to_money</span> }.<span class="ruby-identifier">sum</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-appearance" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">appearance</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>CSS class based on order status.</p>
          
          

          
          <div class="method-source-code" id="appearance-source">
            <pre><span class="ruby-comment"># File app/models/order/presentation.rb, line 9</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">appearance</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">concluded?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-string">&#39;text-muted&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">incomplete?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-string">&#39;text-danger&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">current?</span>
  (<span class="ruby-operator">!</span><span class="ruby-identifier">track_shipments?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">fully_shipped?</span>) <span class="ruby-operator">?</span> <span class="ruby-string">&#39;text-warning&#39;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&#39;warning text-warning&#39;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-apply_shipping_cost-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">apply_shipping_cost!</span><span
            class="method-args">(shipment)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Inserts an order item for the shipping cost using the shipping cost product
with the price queried from the given shipment.</p>
          
          

          
          <div class="method-source-code" id="apply_shipping_cost-21-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 102</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">apply_shipping_cost!</span>(<span class="ruby-identifier">shipment</span>)
  <span class="ruby-identifier">cost</span> = <span class="ruby-identifier">shipment</span>.<span class="ruby-identifier">cost</span>(<span class="ruby-identifier">customer_pricing</span>)
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cost</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">create</span>(
      <span class="ruby-identifier">product</span><span class="ruby-operator">:</span> <span class="ruby-identifier">shipment</span>.<span class="ruby-identifier">shipping_cost_product</span>,
      <span class="ruby-identifier">amount</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>,
      <span class="ruby-identifier">priority</span><span class="ruby-operator">:</span> <span class="ruby-value">1e9</span>,
      <span class="ruby-identifier">price</span><span class="ruby-operator">:</span> <span class="ruby-identifier">cost</span>.<span class="ruby-identifier">amount</span>,
      <span class="ruby-identifier">tax_rate</span><span class="ruby-operator">:</span> <span class="ruby-identifier">cost</span>.<span class="ruby-identifier">tax_rate</span>,
      <span class="ruby-identifier">price_includes_tax</span><span class="ruby-operator">:</span> <span class="ruby-identifier">cost</span>.<span class="ruby-identifier">tax_included</span>,
      <span class="ruby-identifier">label</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;&#39;</span>
    )
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">reload</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-approved-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">approved?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="approved-3F-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 156</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">approved?</span>
  <span class="ruby-operator">!</span><span class="ruby-operator">!</span><span class="ruby-identifier">approved_at</span>.<span class="ruby-identifier">present?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-archive-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">archive!</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Archives the order and its items to permanently record data that is subject
to change.</p>
          
          

          
          <div class="method-source-code" id="archive-21-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 193</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">archive!</span>
  <span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">update</span>(
      <span class="ruby-identifier">store_name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">store</span>.<span class="ruby-identifier">name</span>,
      <span class="ruby-identifier">user_name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:name</span>),
      <span class="ruby-identifier">user_email</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:email</span>),
      <span class="ruby-identifier">user_phone</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:phone</span>),
      <span class="ruby-identifier">order_type_name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">order_type</span>.<span class="ruby-identifier">name</span>
    )
    <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">item</span>.<span class="ruby-identifier">archive!</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-as_json" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">as_json</span><span
            class="method-args">(options = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="as_json-source">
            <pre><span class="ruby-comment"># File app/models/order/presentation.rb, line 36</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">as_json</span>(<span class="ruby-identifier">options</span> = {})
  <span class="ruby-keyword">super</span>(<span class="ruby-identifier">methods</span><span class="ruby-operator">:</span> <span class="ruby-value">:checkout_phase</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-assign_number-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">assign_number!</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="assign_number-21-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 179</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">assign_number!</span>
  <span class="ruby-constant">Order</span>.<span class="ruby-identifier">with_advisory_lock</span>(<span class="ruby-string">&#39;order_numbering&#39;</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">numbered</span> = <span class="ruby-identifier">store</span>.<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">complete</span>.<span class="ruby-identifier">where</span>.<span class="ruby-identifier">not</span>(<span class="ruby-identifier">number</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>).<span class="ruby-identifier">order</span>(<span class="ruby-value">:completed_at</span>)
    <span class="ruby-identifier">current_max</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">numbered</span>.<span class="ruby-identifier">any?</span>
      <span class="ruby-identifier">numbered</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">number</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">store</span>.<span class="ruby-identifier">order_sequence</span>.<span class="ruby-identifier">presence</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">update</span>(<span class="ruby-identifier">number</span><span class="ruby-operator">:</span> <span class="ruby-identifier">current_max</span>.<span class="ruby-identifier">succ</span>, <span class="ruby-identifier">completed_at</span><span class="ruby-operator">:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">current</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-available_order_types" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">available_order_types</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Finds the order types available to this order. These are the outgoing order
types for the source group, excluding those that are not suitable for one
or more products present in the order items.</p>
          
          

          
          <div class="method-source-code" id="available_order_types-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 122</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">available_order_types</span>
  <span class="ruby-identifier">shipping_requirement</span> = <span class="ruby-identifier">requires_shipping?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">source</span>.<span class="ruby-identifier">outgoing_order_types</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">shipping_requirement</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-identifier">source</span>.<span class="ruby-identifier">outgoing_order_types</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">has_shipping</span><span class="ruby-operator">:</span> <span class="ruby-identifier">requires_shipping?</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-available_shipping_methods" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">available_shipping_methods</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Finds the shipping methods available for this order based on which methods
are common to all ordered items. In case the order needs no shipping, no
shipping methods are returned.</p>
          
          

          
          <div class="method-source-code" id="available_shipping_methods-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 54</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">available_shipping_methods</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">ShippingMethod</span>.<span class="ruby-identifier">none</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">has_shipping?</span>
  <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">product</span>.<span class="ruby-identifier">available_shipping_methods</span>.<span class="ruby-identifier">pluck</span>(<span class="ruby-value">:id</span>) }.<span class="ruby-identifier">inject</span>(<span class="ruby-value">:&amp;</span>)
  <span class="ruby-identifier">store</span>.<span class="ruby-identifier">shipping_methods</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">ids</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-balance" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">balance</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="balance-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 216</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">balance</span>
  <span class="ruby-identifier">grand_total_with_tax</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">payments</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:amount</span>).<span class="ruby-identifier">sum</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-billing_address_components" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">billing_address_components</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="billing_address_components-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 64</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">billing_address_components</span>
  <span class="ruby-identifier">has_billing_address?</span> <span class="ruby-operator">?</span>
    [<span class="ruby-identifier">billing_address</span>, <span class="ruby-identifier">billing_postalcode</span>, <span class="ruby-identifier">billing_city</span>] <span class="ruby-operator">:</span>
    [<span class="ruby-identifier">shipping_address</span>, <span class="ruby-identifier">shipping_postalcode</span>, <span class="ruby-identifier">shipping_city</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-billing_address_required-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">billing_address_required?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="billing_address_required-3F-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 23</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">billing_address_required?</span>
  <span class="ruby-identifier">has_billing_address?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">has_payment?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">has_shipping?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-cancelled-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cancelled?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="cancelled-3F-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 148</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">cancelled?</span>
  <span class="ruby-identifier">cancelled_at</span>.<span class="ruby-identifier">present?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-checkout_phase" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">checkout_phase</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p><a href="Order.html">Order</a> phase in the checkout process. This is
included in the JSON representation for checkout.coffee to reveal the
corresponding form elements.</p>
          
          

          
          <div class="method-source-code" id="checkout_phase-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 253</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">checkout_phase</span>
  <span class="ruby-keyword">return</span> <span class="ruby-value">:address</span>  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-value">:shipping</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">has_shipping?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">shipments</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-value">:payment</span>  <span class="ruby-keyword">if</span> <span class="ruby-identifier">has_payment?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">paid?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-value">:complete</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-checkoutable-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">checkoutable?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>An order is checkoutable when all its real items can be satisfied from the
target inventory.</p>
          
          

          
          <div class="method-source-code" id="checkoutable-3F-source">
            <pre><span class="ruby-comment"># File app/models/order/contents.rb, line 83</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">checkoutable?</span>
  <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">real</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">satisfied?</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-clear_shipping_costs-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clear_shipping_costs!</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="clear_shipping_costs-21-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 123</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">clear_shipping_costs!</span>
  <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">product</span><span class="ruby-operator">:</span> <span class="ruby-identifier">store</span>.<span class="ruby-identifier">shipping_cost_products</span>).<span class="ruby-identifier">destroy_all</span>
  <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">reload</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-complete-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">complete!</span><span
            class="method-args">(acknowledge = true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Completing an order assigns it a number, archives it, sends order
receipt/acknowledge, and triggers an XML export job.</p>
          
          

          
          <div class="method-source-code" id="complete-21-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 172</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">complete!</span>(<span class="ruby-identifier">acknowledge</span> = <span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">assign_number!</span>
  <span class="ruby-identifier">archive!</span>
  <span class="ruby-identifier">email</span>(<span class="ruby-identifier">has_payment?</span> <span class="ruby-operator">?</span> <span class="ruby-value">:receipt</span> <span class="ruby-operator">:</span> <span class="ruby-value">:acknowledge</span>, <span class="ruby-identifier">customer_string</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">acknowledge</span>
  <span class="ruby-identifier">export_xml</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-complete-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">complete?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="complete-3F-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 136</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">complete?</span>
  <span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">present?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-concludable-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">concludable?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="concludable-3F-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 152</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">concludable?</span>
  <span class="ruby-identifier">pending?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">track_shipments?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">fully_shipped?</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-concluded-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">concluded?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="concluded-3F-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 160</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">concluded?</span>
  <span class="ruby-operator">!</span><span class="ruby-operator">!</span><span class="ruby-identifier">concluded_at</span>.<span class="ruby-identifier">present?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-contact_string" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">contact_string</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="contact_string-source">
            <pre><span class="ruby-comment"># File app/models/order/presentation.rb, line 44</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">contact_string</span>
  <span class="ruby-identifier">has_contact_info?</span> <span class="ruby-operator">?</span> <span class="ruby-node">&quot;#{contact_person} &lt;#{contact_email}&gt;&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-copy_items_to" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">copy_items_to</span><span
            class="method-args">(another_order)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Copies the contents of this order to another order by inserting the top
level real items. Pricing is according to the source group of the target
order.</p>
          
          

          
          <div class="method-source-code" id="copy_items_to-source">
            <pre><span class="ruby-comment"># File app/models/order/contents.rb, line 63</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">copy_items_to</span>(<span class="ruby-identifier">another_order</span>)
  <span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">top_level</span>.<span class="ruby-identifier">real</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">another_order</span>.<span class="ruby-identifier">insert</span>(<span class="ruby-identifier">item</span>.<span class="ruby-identifier">product</span>, <span class="ruby-identifier">item</span>.<span class="ruby-identifier">amount</span>, <span class="ruby-identifier">another_order</span>.<span class="ruby-identifier">source</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-current-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">current?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="current-3F-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 132</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">current?</span>
  <span class="ruby-identifier">complete?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">approved?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-customer_pricing" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">customer_pricing</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Pricing applied to this order, based on source group.</p>
          
          

          
          <div class="method-source-code" id="customer_pricing-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 111</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">customer_pricing</span>
  <span class="ruby-constant">Appraiser</span><span class="ruby-operator">::</span><span class="ruby-constant">Product</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">source</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-customer_string" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">customer_string</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="customer_string-source">
            <pre><span class="ruby-comment"># File app/models/order/presentation.rb, line 48</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">customer_string</span>
  <span class="ruby-node">&quot;#{customer_name} &lt;#{customer_email}&gt;&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-earliest_shipping_at" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">earliest_shipping_at</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="earliest_shipping_at-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 47</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">earliest_shipping_at</span>
  (<span class="ruby-identifier">completed_at</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">current</span>).<span class="ruby-identifier">to_date</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">lead_time_days</span>.<span class="ruby-identifier">days</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-editable_items-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">editable_items?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="editable_items-3F-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 128</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">editable_items?</span>
  <span class="ruby-identifier">incomplete?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-email" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">email</span><span
            class="method-args">(message, to, items = nil, options = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="email-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 265</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">email</span>(<span class="ruby-identifier">message</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">items</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-identifier">options</span>.<span class="ruby-identifier">reverse_merge!</span>(
    <span class="ruby-identifier">bcc</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>,
    <span class="ruby-identifier">pricing</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
  )
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">store</span>.<span class="ruby-identifier">disable_mail?</span>
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;Sending of e-mail is currently disabled, aborting&quot;</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">OrderMailer</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">message</span>, <span class="ruby-keyword">self</span>, <span class="ruby-identifier">to</span>, <span class="ruby-identifier">items</span>, <span class="ruby-identifier">options</span>).<span class="ruby-identifier">deliver_later</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-empty-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">empty?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>An order is empty when it&#39;s empty of real products.</p>
          
          

          
          <div class="method-source-code" id="empty-3F-source">
            <pre><span class="ruby-comment"># File app/models/order/contents.rb, line 72</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">empty?</span>
  <span class="ruby-identifier">products</span>.<span class="ruby-identifier">real</span>.<span class="ruby-identifier">empty?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-external_identifier" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">external_identifier</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="external_identifier-source">
            <pre><span class="ruby-comment"># File app/models/order/presentation.rb, line 52</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">external_identifier</span>
  [<span class="ruby-identifier">store</span>.<span class="ruby-identifier">erp_number</span>, <span class="ruby-identifier">number</span>].<span class="ruby-identifier">join</span> <span class="ruby-string">&#39;/&#39;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-forward_to" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">forward_to</span><span
            class="method-args">(another_order)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Forwards this order as another order by replacing its items with items from
this order, and copying some relevant info over.</p>
          
          

          
          <div class="method-source-code" id="forward_to-source">
            <pre><span class="ruby-comment"># File app/models/order/contents.rb, line 107</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">forward_to</span>(<span class="ruby-identifier">another_order</span>)
  <span class="ruby-identifier">another_order</span>.<span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">destroy_all</span>
  <span class="ruby-identifier">copy_items_to</span>(<span class="ruby-identifier">another_order</span>)
  <span class="ruby-identifier">another_order</span>.<span class="ruby-identifier">update</span>(
    <span class="ruby-identifier">shipping_at</span><span class="ruby-operator">:</span> <span class="ruby-identifier">shipping_at</span>,
    <span class="ruby-identifier">installation_at</span><span class="ruby-operator">:</span> <span class="ruby-identifier">installation_at</span>,
    <span class="ruby-identifier">company_name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">company_name</span>,
    <span class="ruby-identifier">contact_person</span><span class="ruby-operator">:</span> <span class="ruby-identifier">contact_person</span>,
    <span class="ruby-identifier">contact_email</span><span class="ruby-operator">:</span> <span class="ruby-identifier">contact_email</span>,
    <span class="ruby-identifier">contact_phone</span><span class="ruby-operator">:</span> <span class="ruby-identifier">contact_phone</span>,
    <span class="ruby-identifier">has_billing_address</span><span class="ruby-operator">:</span> <span class="ruby-identifier">has_billing_address</span>,
    <span class="ruby-identifier">billing_address</span><span class="ruby-operator">:</span> <span class="ruby-identifier">billing_address</span>,
    <span class="ruby-identifier">billing_postalcode</span><span class="ruby-operator">:</span> <span class="ruby-identifier">billing_postalcode</span>,
    <span class="ruby-identifier">billing_city</span><span class="ruby-operator">:</span> <span class="ruby-identifier">billing_city</span>,
    <span class="ruby-identifier">billing_country</span><span class="ruby-operator">:</span> <span class="ruby-identifier">billing_country</span>,
    <span class="ruby-identifier">shipping_address</span><span class="ruby-operator">:</span> <span class="ruby-identifier">shipping_address</span>,
    <span class="ruby-identifier">shipping_postalcode</span><span class="ruby-operator">:</span> <span class="ruby-identifier">shipping_postalcode</span>,
    <span class="ruby-identifier">shipping_city</span><span class="ruby-operator">:</span> <span class="ruby-identifier">shipping_city</span>,
    <span class="ruby-identifier">shipping_country</span><span class="ruby-operator">:</span> <span class="ruby-identifier">shipping_country</span>,
    <span class="ruby-identifier">notes</span><span class="ruby-operator">:</span> <span class="ruby-identifier">notes</span>
  )
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-fully_shipped-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">fully_shipped?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="fully_shipped-3F-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 43</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">fully_shipped?</span>
  <span class="ruby-operator">!</span>(<span class="ruby-identifier">has_pending_shipment?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">items_pending_shipping</span>.<span class="ruby-identifier">any?</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-grand_total_for_export" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">grand_total_for_export</span><span
            class="method-args">(items = order_items)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Grand total for exported orders.</p>
          
          

          
          <div class="method-source-code" id="grand_total_for_export-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 244</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">grand_total_for_export</span>(<span class="ruby-identifier">items</span> = <span class="ruby-identifier">order_items</span>)
  <span class="ruby-identifier">items</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
    (<span class="ruby-identifier">item</span>.<span class="ruby-identifier">subtotal_for_export</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>.<span class="ruby-identifier">to_money</span>) <span class="ruby-operator">+</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">adjustments_sans_tax</span>
  }.<span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">adjustments_sans_tax</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-grand_total_sans_tax" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">grand_total_sans_tax</span><span
            class="method-args">(items = order_items)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Grand total for the given items (or whole order), without tax.</p>
          
          

          
          <div class="method-source-code" id="grand_total_sans_tax-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 221</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">grand_total_sans_tax</span>(<span class="ruby-identifier">items</span> = <span class="ruby-identifier">order_items</span>)
  <span class="ruby-identifier">items</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">grand_total_sans_tax</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>.<span class="ruby-identifier">to_money</span> }.<span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">adjustments_sans_tax</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-grand_total_with_tax" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">grand_total_with_tax</span><span
            class="method-args">(items = order_items)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Same as above, with tax.</p>
          
          

          
          <div class="method-source-code" id="grand_total_with_tax-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 226</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">grand_total_with_tax</span>(<span class="ruby-identifier">items</span> = <span class="ruby-identifier">order_items</span>)
  <span class="ruby-identifier">items</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">grand_total_with_tax</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>.<span class="ruby-identifier">to_money</span> }.<span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">adjustments_with_tax</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-has_contact_info-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">has_contact_info?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="has_contact_info-3F-source">
            <pre><span class="ruby-comment"># File app/models/order/presentation.rb, line 40</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">has_contact_info?</span>
  <span class="ruby-identifier">contact_person</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">contact_email</span>.<span class="ruby-identifier">present?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-has_installation-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">has_installation?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="has_installation-3F-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 208</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">has_installation?</span>
  <span class="ruby-identifier">order_type</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">order_type</span>.<span class="ruby-identifier">has_installation?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-has_payment-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">has_payment?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="has_payment-3F-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 60</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">has_payment?</span>
  <span class="ruby-identifier">order_type</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">order_type</span>.<span class="ruby-identifier">has_payment?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-has_pending_shipment-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">has_pending_shipment?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="has_pending_shipment-3F-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 39</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">has_pending_shipment?</span>
  <span class="ruby-identifier">shipments</span>.<span class="ruby-identifier">pending</span>.<span class="ruby-identifier">any?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-has_shipping-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">has_shipping?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p><a href="Order.html">Order</a> having shipping is simply from the order
type, once it has been assigned. See <a
href="Order.html#method-i-requires_shipping-3F">requires_shipping?</a></p>
          
          

          
          <div class="method-source-code" id="has_shipping-3F-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 29</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">has_shipping?</span>
  <span class="ruby-identifier">order_type</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">order_type</span>.<span class="ruby-identifier">has_shipping?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-icon" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">icon</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Icon name based on order status.</p>
          
          

          
          <div class="method-source-code" id="icon-source">
            <pre><span class="ruby-comment"># File app/models/order/presentation.rb, line 29</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">icon</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">concluded?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-string">&#39;pencil&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">incomplete?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-string">&#39;check&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">current?</span>
  (<span class="ruby-operator">!</span><span class="ruby-identifier">track_shipments?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">fully_shipped?</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-string">&#39;search&#39;</span> <span class="ruby-operator">||</span> <span class="ruby-string">&#39;truck&#39;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-incomplete-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">incomplete?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="incomplete-3F-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 140</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">incomplete?</span>
  <span class="ruby-operator">!</span><span class="ruby-identifier">complete?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-insert" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">insert</span><span
            class="method-args">(product, amount, group, options = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Inserts amount of product to this order in the context of given group.
Options may include a parent item for grouping the order items, and a
specific lot code.</p>
          
          

          
          <div class="method-source-code" id="insert-source">
            <pre><span class="ruby-comment"># File app/models/order/contents.rb, line 13</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">insert</span>(<span class="ruby-identifier">product</span>, <span class="ruby-identifier">amount</span>, <span class="ruby-identifier">group</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">product</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">product</span>.<span class="ruby-identifier">bundle?</span>
    <span class="ruby-identifier">insert_components</span>(<span class="ruby-identifier">product</span>, <span class="ruby-identifier">amount</span>, <span class="ruby-identifier">group</span>,
      <span class="ruby-identifier">parent_item</span><span class="ruby-operator">:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:parent_item</span>]
    )
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">insert_single</span>(<span class="ruby-identifier">product</span>, <span class="ruby-identifier">amount</span>, <span class="ruby-identifier">group</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>(
      <span class="ruby-identifier">separate_components</span><span class="ruby-operator">:</span> <span class="ruby-identifier">product</span>.<span class="ruby-identifier">composite?</span>
    ))
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-insert_components" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">insert_components</span><span
            class="method-args">(product, amount, group, options = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Inserts the component products of given product to this order. Options may
include a parent item only, other references are lost.</p>
          
          

          
          <div class="method-source-code" id="insert_components-source">
            <pre><span class="ruby-comment"># File app/models/order/contents.rb, line 28</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">insert_components</span>(<span class="ruby-identifier">product</span>, <span class="ruby-identifier">amount</span>, <span class="ruby-identifier">group</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-identifier">product</span>.<span class="ruby-identifier">component_entries</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">entry</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">insert</span>(<span class="ruby-identifier">entry</span>.<span class="ruby-identifier">component</span>, <span class="ruby-identifier">amount</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">quantity</span>, <span class="ruby-identifier">group</span>, <span class="ruby-identifier">options</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-insert_single" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">insert_single</span><span
            class="method-args">(product, amount, group, options = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Inserts a single product to this order, optionally with separate
components.</p>
          
          

          
          <div class="method-source-code" id="insert_single-source">
            <pre><span class="ruby-comment"># File app/models/order/contents.rb, line 35</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">insert_single</span>(<span class="ruby-identifier">product</span>, <span class="ruby-identifier">amount</span>, <span class="ruby-identifier">group</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-identifier">pricing</span> = <span class="ruby-constant">Appraiser</span><span class="ruby-operator">::</span><span class="ruby-constant">Product</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">group</span>)
  <span class="ruby-identifier">final_price</span> = <span class="ruby-identifier">pricing</span>.<span class="ruby-identifier">for_order</span>(<span class="ruby-identifier">product</span>)
  <span class="ruby-identifier">label</span> = <span class="ruby-identifier">product</span>.<span class="ruby-identifier">best_promoted_item</span>(<span class="ruby-identifier">group</span>).<span class="ruby-identifier">try</span>(<span class="ruby-value">:description</span>)
  <span class="ruby-identifier">order_item</span> = <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">create_with</span>(
    <span class="ruby-identifier">amount</span><span class="ruby-operator">:</span> <span class="ruby-value">0</span>,
    <span class="ruby-identifier">priority</span><span class="ruby-operator">:</span> <span class="ruby-identifier">order_items_count</span>
  ).<span class="ruby-identifier">find_or_create_by</span>(
    <span class="ruby-identifier">product</span><span class="ruby-operator">:</span> <span class="ruby-identifier">product</span>,
    <span class="ruby-identifier">parent_item</span><span class="ruby-operator">:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:parent_item</span>],
    <span class="ruby-identifier">lot_code</span><span class="ruby-operator">:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:lot_code</span>]
  )
  <span class="ruby-identifier">order_item</span>.<span class="ruby-identifier">update!</span>(
    <span class="ruby-identifier">amount</span><span class="ruby-operator">:</span> <span class="ruby-identifier">order_item</span>.<span class="ruby-identifier">amount</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">amount</span>,
    <span class="ruby-identifier">price</span><span class="ruby-operator">:</span> <span class="ruby-identifier">final_price</span>.<span class="ruby-identifier">amount</span>,
    <span class="ruby-identifier">tax_rate</span><span class="ruby-operator">:</span> <span class="ruby-identifier">final_price</span>.<span class="ruby-identifier">tax_rate</span>,
    <span class="ruby-identifier">price_includes_tax</span><span class="ruby-operator">:</span> <span class="ruby-identifier">final_price</span>.<span class="ruby-identifier">tax_included</span>,
    <span class="ruby-identifier">label</span><span class="ruby-operator">:</span> <span class="ruby-identifier">label</span> <span class="ruby-operator">||</span> <span class="ruby-string">&#39;&#39;</span>
  )
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:separate_components</span>]
    <span class="ruby-identifier">insert_components</span>(<span class="ruby-identifier">product</span>, <span class="ruby-identifier">amount</span>, <span class="ruby-identifier">group</span>, <span class="ruby-identifier">parent_item</span><span class="ruby-operator">:</span> <span class="ruby-identifier">order_item</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">order_item</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-items_by_vendor" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">items_by_vendor</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Coalesces items in this order into a hash by product vendor.</p>
          
          

          
          <div class="method-source-code" id="items_by_vendor-source">
            <pre><span class="ruby-comment"># File app/models/order/contents.rb, line 131</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">items_by_vendor</span>
  <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-identifier">product</span><span class="ruby-operator">:</span> <span class="ruby-value">:vendor</span>).<span class="ruby-identifier">group_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">product</span>.<span class="ruby-identifier">vendor</span> }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-items_pending_shipping" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">items_pending_shipping</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Collects order items that have not been fully shipped yet.</p>
          
          

          
          <div class="method-source-code" id="items_pending_shipping-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 119</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">items_pending_shipping</span>
  <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">pending_shipping?</span> }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-lead_time_days" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">lead_time_days</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p><a href="Order.html">Order</a> lead time is based on its back ordered
items.</p>
          
          

          
          <div class="method-source-code" id="lead_time_days-source">
            <pre><span class="ruby-comment"># File app/models/order/contents.rb, line 136</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">lead_time_days</span>
  <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">reject</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">item</span>.<span class="ruby-identifier">available?</span>
  }.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">item</span>.<span class="ruby-identifier">product</span>.<span class="ruby-identifier">lead_time_days</span>
  }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">max</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-life_pro_tip" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">life_pro_tip</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="life_pro_tip-source">
            <pre><span class="ruby-comment"># File app/models/order/presentation.rb, line 16</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">life_pro_tip</span>
  <span class="ruby-keyword">return</span> [<span class="ruby-value">:info</span>, <span class="ruby-string">&#39;.concluded&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">concluded?</span>
  <span class="ruby-keyword">return</span> [<span class="ruby-value">:info</span>, <span class="ruby-string">&#39;.incomplete&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">incomplete?</span>
  <span class="ruby-keyword">return</span> [<span class="ruby-value">:danger</span>, <span class="ruby-string">&#39;.current&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">current?</span>
  <span class="ruby-keyword">return</span> [<span class="ruby-value">:warning</span>, <span class="ruby-string">&#39;.shipped&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">concludable?</span>
  [<span class="ruby-value">:warning</span>, <span class="ruby-string">&#39;.pending&#39;</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-notified_users" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">notified_users</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Notify users with order_notify role in the destination group.</p>
          
          

          
          <div class="method-source-code" id="notified_users-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 261</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">notified_users</span>
  <span class="ruby-identifier">destination</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">with_role</span>(<span class="ruby-value">:order_notify</span>, <span class="ruby-identifier">store</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-order_type_name" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">order_type_name</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="order_type_name-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 94</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">order_type_name</span>
  <span class="ruby-identifier">concluded?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">self</span>[<span class="ruby-value">:order_type_name</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">order_type</span>.<span class="ruby-identifier">name</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-paid-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">paid?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="paid-3F-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 212</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">paid?</span>
  <span class="ruby-identifier">balance</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span>.<span class="ruby-identifier">to_money</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-pending-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">pending?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="pending-3F-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 144</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">pending?</span>
  <span class="ruby-identifier">approved?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">concluded?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-recalculate-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">recalculate!</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Recalculates things that may take some heavy lifting. This should be called
when the contents of the order have changed.</p>
          
          

          
          <div class="method-source-code" id="recalculate-21-source">
            <pre><span class="ruby-comment"># File app/models/order/contents.rb, line 100</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">recalculate!</span>
  <span class="ruby-identifier">apply_promotions!</span>
  <span class="ruby-identifier">reload</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-requires_shipping-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">requires_shipping?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p><a href="Order.html">Order</a> requiring shipping is determined by its
contents. A single item that requires shipping will demand shipping for the
whole order. Returns nil for not applicable (no items).</p>
          
          

          
          <div class="method-source-code" id="requires_shipping-3F-source">
            <pre><span class="ruby-comment"># File app/models/order/contents.rb, line 93</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">requires_shipping?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">any?</span>
  <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">tangible</span>.<span class="ruby-identifier">any?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-should_complete-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">should_complete?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p><a href="Order.html">Order</a> should complete when it reaches complete
phase at checkout but hasn&#39;t been completed yet.</p>
          
          

          
          <div class="method-source-code" id="should_complete-3F-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 166</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">should_complete?</span>
  <span class="ruby-identifier">incomplete?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">checkout_phase</span> <span class="ruby-operator">==</span> <span class="ruby-value">:complete</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-should_copy_billing_address-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">should_copy_billing_address?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="should_copy_billing_address-3F-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 19</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">should_copy_billing_address?</span>
  <span class="ruby-identifier">has_shipping?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">has_payment?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">has_billing_address?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-size" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">size</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="size-source">
            <pre><span class="ruby-comment"># File app/models/order/contents.rb, line 76</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">size</span>
  <span class="ruby-identifier">real_items</span> = <span class="ruby-identifier">order_items</span>.<span class="ruby-identifier">real</span>.<span class="ruby-identifier">sum</span>(<span class="ruby-value">:amount</span>)
  <span class="ruby-identifier">real_items</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">real_items</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-source" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">source</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p><a href="Order.html">Order</a> source group is independent of order type.</p>
          
          

          
          <div class="method-source-code" id="source-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 106</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">source</span>
  <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">group</span>(<span class="ruby-identifier">store</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-summary" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">summary</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="summary-source">
            <pre><span class="ruby-comment"># File app/models/order/presentation.rb, line 24</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">summary</span>
  [<span class="ruby-identifier">contact_person</span>, <span class="ruby-identifier">shipping_city</span>].<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">reject</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:empty?</span>).<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;, &#39;</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-targeted-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">targeted?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Orders targeted at another customer, not the user herself. This also
indicates the order is considered to be a quote when incomplete.</p>
          
          

          
          <div class="method-source-code" id="targeted-3F-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 101</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">targeted?</span>
  <span class="ruby-identifier">user</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">customer</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-tax_total" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">tax_total</span><span
            class="method-args">(items = order_items)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Total tax for the given items.</p>
          
          

          
          <div class="method-source-code" id="tax_total-source">
            <pre><span class="ruby-comment"># File app/models/order.rb, line 231</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">tax_total</span>(<span class="ruby-identifier">items</span> = <span class="ruby-identifier">order_items</span>)
  <span class="ruby-identifier">items</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">tax_total</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>.<span class="ruby-identifier">to_money</span> }.<span class="ruby-identifier">sum</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-timeline_events" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">timeline_events</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Vis.js timeline representation of order events.</p>
          
          

          
          <div class="method-source-code" id="timeline_events-source">
            <pre><span class="ruby-comment"># File app/models/order/presentation.rb, line 57</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">timeline_events</span>
  <span class="ruby-identifier">events</span> = []

  <span class="ruby-identifier">events</span> <span class="ruby-operator">&lt;&lt;</span> {
    <span class="ruby-identifier">group</span><span class="ruby-operator">:</span> <span class="ruby-identifier">id</span>, <span class="ruby-identifier">type</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;range&#39;</span>,
    <span class="ruby-identifier">className</span><span class="ruby-operator">:</span> (<span class="ruby-identifier">approved?</span> <span class="ruby-operator">?</span> <span class="ruby-string">&#39;primary&#39;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&#39;danger&#39;</span>),
    <span class="ruby-identifier">content</span><span class="ruby-operator">:</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">l</span>(<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">to_date</span>),
    <span class="ruby-identifier">start</span><span class="ruby-operator">:</span> <span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">to_date</span>,
    <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-to_s" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">to_s</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="to_s-source">
            <pre><span class="ruby-comment"># File app/models/order/presentation.rb, line 3</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">to_s</span>
  <span class="ruby-keyword">return</span> <span class="ruby-node">&quot;#{Order.human_attribute_name(:number)} #{number}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">complete?</span>
  <span class="ruby-constant">Order</span>.<span class="ruby-identifier">human_attribute_value</span>(<span class="ruby-value">:status</span>, <span class="ruby-value">:incomplete</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-track_shipments-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">track_shipments?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Shipments are tracked via transfers, unless the store has them disabled.</p>
          
          

          
          <div class="method-source-code" id="track_shipments-3F-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 35</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">track_shipments?</span>
  <span class="ruby-operator">!</span><span class="ruby-identifier">store</span>.<span class="ruby-identifier">disable_shipment_transfers?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-vat_number_expected-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">vat_number_expected?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>VAT numbers are not mandatory, but expected to be present in orders billed
at a different country from the store home country.</p>
          
          

          
          <div class="method-source-code" id="vat_number_expected-3F-source">
            <pre><span class="ruby-comment"># File app/models/order/shipping_and_billing.rb, line 72</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">vat_number_expected?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">has_payment?</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">has_billing_address?</span>
    <span class="ruby-identifier">billing_country</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">store</span>.<span class="ruby-identifier">country</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">shipping_country</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">store</span>.<span class="ruby-identifier">country</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.3.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

