= bootstrap_form_for [:admin, @product], layout: :horizontal,
    label_col: 'col-sm-4', control_col: 'col-sm-8' do |f|
  %ul.nav.nav-tabs.panel-tabs{role: 'tablist'}
    %li.active{role: 'presentation'}
      %a{href: '#tab-product-meta', role: 'tab', data: {toggle: 'tab'}}
        = col(Product, :metadata)
    %li{role: 'presentation'}
      %a{href: '#tab-product-text', role: 'tab', data: {toggle: 'tab'}}
        = col(Product, :text)
    %li.master-disable{role: 'presentation', class: @product.master? ? 'disabled' : ''}
      %a{href: '#tab-product-pricing', role: 'tab', data: {toggle: 'tab'}}
        = col(Product, :pricing)
    %li.master-disable{role: 'presentation', class: @product.master? ? 'disabled' : ''}
      %a{href: '#tab-product-shipping', role: 'tab', data: {toggle: 'tab'}}
        = col(Product, :shipping)

  .panel.panel-default.tabbed-panel
    .panel-body
      .tab-content
        #tab-product-meta.tab-pane.fade.in.active
          %fieldset{disabled: locked}
            = f.select :purpose, Product.purpose_options, {}, {class: 'selectize'}
            .variant-only.collapse{class: @product.variant? ? 'in' : ''}
              = f.select :master_product_id, @product.master_product_options, {include_blank: true}, {class: 'selectize'}
            .master-only.collapse{class: @product.master? ? 'in' : ''}
              = f.select :variant_ids, @product.available_variant_options, {}, {multiple: true, class: 'selectize'}
            = f.select :category_ids, current_user.category_options, {include_blank: true}, {multiple: true, class: 'selectize'}
            = f.select :vendor_id, current_store.users.vendor.map { |u| [u.name, u.id] }, {include_blank: true}, {class: 'selectize', disabled: current_user.vendor?}
            = f.text_field :code, required: true
            = f.text_field :customer_code
            = f.text_field :available_at,
                data: {provide: 'datepicker', 'date-format' => 'yyyy-mm-dd', 'date-language' => I18n.locale}
            = f.text_field :deleted_at,
                data: {provide: 'datepicker', 'date-format' => 'yyyy-mm-dd', 'date-language' => I18n.locale}
            = f.text_area :memo, rows: 2

        #tab-product-text.tab-pane.fade
          %fieldset{disabled: locked}
            = f.text_field :title, required: true
            = f.text_field :subtitle
            = f.text_area :description

        #tab-product-pricing.tab-pane.fade
          %fieldset{disabled: locked}
            = f.select :tax_category_id, current_store.tax_categories.map { |t| [t.to_s, t.id] }
            - if current_user.manufacturer?
              = f.text_field :cost_price, append: '€', control_col: 'col-sm-4', class: 'text-right'
            .form-group
              %label.control-label.col-sm-4= col(Product, :trade_price)
              .col-sm-4
                .input-group
                  = f.text_field_without_bootstrap :trade_price, class: 'form-control text-right'
                  %span.input-group-addon €
              .col-sm-4
                .input-group
                  %span.input-group-addon= col(Product, :markup_percent)
                  = text_field_tag :markup_percent, number_with_precision(@product.markup_percent, precision: 2), class: 'form-control text-right'
            .form-group
              %label.control-label.col-sm-4= col(Product, :retail_price)
              .col-sm-4
                .input-group
                  = f.text_field_without_bootstrap :retail_price, class: 'form-control text-right'
                  %span.input-group-addon €
                .help-block
                  #tax-included.collapse{class: @product.tax_category.included_in_retail? ? 'in' : ''}
                    = t('.tax_included_in_retail_html')
                  #tax-excluded.collapse{class: @product.tax_category.included_in_retail? ? '' : 'in'}
                    = t('.tax_excluded_in_retail_html')
              .col-sm-4
                .input-group
                  %span.input-group-addon= col(Product, :margin_percent)
                  = text_field_tag :margin_percent, number_with_precision(@product.margin_percent, precision: 2), class: 'form-control text-right'

        #tab-product-shipping.tab-pane.fade
          %fieldset{disabled: locked}
            = f.text_field :mass, append: 'g', class: 'text-right'
            .form-group
              %label.control-label.col-sm-4= col(Product, :dimensions)
              .col-sm-8
                .input-group
                  = f.text_field_without_bootstrap :dimension_u, class: 'form-control text-right'
                  %span.input-group-addon ⨯
                  = f.text_field_without_bootstrap :dimension_v, class: 'form-control text-right'
                  %span.input-group-addon ⨯
                  = f.text_field_without_bootstrap :dimension_w, class: 'form-control text-right'
                  %span.input-group-addon mm
            = f.text_field :lead_time, append: col(Product, :lead_time_unit), class: 'text-right'
            = f.text_area :shipping_notes, rows: 2, help: t('.shipping_notes_help')

      - unless locked
        %fieldset.actions
          = f.form_group do
            = f.primary

:coffee
  numbro.culture "#{t('culture')}"
  $('#product_trade_price').on 'change', (e) ->
    update_markup_margin()
    $('#markup_percent, #margin_percent').effect 'highlight'
  $('#product_retail_price').on 'change', (e) ->
    update_markup_margin()
    $('#markup_percent, #margin_percent').effect 'highlight'

  $('#markup_percent').on 'change', (e) ->
    markup_percent = numbro().unformat $('#markup_percent').val()
    trade_price = numbro().unformat $('#product_trade_price').val()
    retail_price = trade_price * (1 + markup_percent/100.0)
    $('#product_retail_price').val numbro(retail_price).format('0.00')
    update_markup_margin()
    $('#product_retail_price, #margin_percent').effect 'highlight'

  $('#margin_percent').on 'change', (e) ->
    margin_percent = numbro().unformat $('#margin_percent').val()
    trade_price = numbro().unformat $('#product_trade_price').val()
    retail_price = - trade_price / (margin_percent/100.0 - 1)
    $('#product_retail_price').val numbro(retail_price).format('0.00')
    update_markup_margin()
    $('#product_retail_price, #markup_percent').effect 'highlight'

  tax_categories = #{current_store.tax_categories.map { |t| [t.id, t.included_in_retail?] }.to_h.to_json}

  $('#product_tax_category_id').selectize
      dropdownParent: 'body'
      onChange: (index) ->
        if tax_categories[index]
          $('#tax-included').collapse 'show'
          $('#tax-excluded').collapse 'hide'
        else
          $('#tax-included').collapse 'hide'
          $('#tax-excluded').collapse 'show'

  $('#product_purpose').on 'change', (e) ->
    switch $(e.target).val()
      when 'master'
        $('.variant-only').collapse 'hide'
        $('.master-only').collapse 'show'
        $('.master-disable').addClass 'disabled'
        $('#product_master_product_id')[0].selectize.setValue ''
      when 'variant'
        $('.master-only').collapse 'hide'
        $('.variant-only').collapse 'show'
        $('.master-disable').removeClass 'disabled'
        $('#product_variant_ids')[0].selectize.setValue ''
      else
        $('.master-only').collapse 'hide'
        $('.variant-only').collapse 'hide'
        $('.master-disable').removeClass 'disabled'
        $('#product_variant_ids')[0].selectize.setValue ''
        $('#product_master_product_id')[0].selectize.setValue ''

  $('#product_description').summernote
    lang: "#{t('culture')}"
    toolbar: [
      ['para', ['style', 'ul', 'ol', 'paragraph']]
      ['font', ['bold', 'italic', 'clear']]
    ]
    dialogsFade: true
